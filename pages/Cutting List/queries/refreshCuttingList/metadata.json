{
  "gitSyncId": "699387b8cf3d5e4f99911848_cl000001-0000-0000-0000-000000000003",
  "id": "Cutting List_refreshCuttingList",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "TRUNCATE TABLE cutting_list;\n\nINSERT INTO cutting_list (timber, profile, bom_length, order_length, total_qty, volume_m3, sort_order)\nSELECT\n    b.timber,\n    b.profile,\n    b.length AS bom_length,\n    COALESCE(sp_longer.length, b.length) AS order_length,\n    SUM(b.qty * pr.qty) AS total_qty,\n    ROUND(SUM(\n        b.qty * pr.qty *\n        (SPLIT_PART(b.profile, 'x', 1)::numeric / 1000) *\n        (SPLIT_PART(b.profile, 'x', 2)::numeric / 1000) *\n        (COALESCE(sp_longer.length, b.length)::numeric / 1000)\n    ), 6) AS volume_m3,\n    ROW_NUMBER() OVER (ORDER BY b.timber, b.profile, b.length DESC) AS sort_order\nFROM production_runs pr\nJOIN bom b ON pr.product_no = b.product_no\nLEFT JOIN stock_profiles sp_exact\n    ON b.timber = sp_exact.timber\n    AND b.profile = sp_exact.profile\n    AND b.length = sp_exact.length\nLEFT JOIN LATERAL (\n    SELECT length FROM stock_profiles\n    WHERE timber = b.timber AND profile = b.profile AND length > b.length\n    ORDER BY length ASC LIMIT 1\n) sp_longer ON sp_exact.id IS NULL\nLEFT JOIN stock_profiles sp_raw\n    ON b.timber = sp_raw.timber\n    AND b.profile = sp_raw.profile\n    AND sp_raw.length IS NULL\n    AND sp_exact.id IS NULL\n    AND sp_longer.length IS NULL\nWHERE pr.status = 'Pending'\n    AND sp_exact.id IS NULL\n    AND (sp_longer.length IS NOT NULL OR sp_raw.id IS NOT NULL)\nGROUP BY b.timber, b.profile, b.length, COALESCE(sp_longer.length, b.length)\nORDER BY b.timber, b.profile, b.length DESC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [{ "value": true }],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": true,
    "datasource": {
      "id": "Access MRP",
      "isAutoGenerated": false,
      "name": "Access MRP",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [],
    "name": "refreshCuttingList",
    "pageId": "Cutting List",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}
